/**
 * @file matrix.h
 * @brief Заголовочный файл класса Matrix
 * @author Anna Dolgopolova
 * @email ardolgopolova@edu.hse.ru
 * @date 29.09.2025
 * @version 1.0
 */

#ifndef LINALG_MATRIX_H
#define LINALG_MATRIX_H

#include <cstddef>
#include <initializer_list>
#include <iostream>
#include <ostream>
/**
 * @namespace linalg
 * @brief Пространство имён для библиотеки линейной алгебры.
 *
 * Содержит определения и функции для работы с матрицами, а также базовые
 * операции линейной алгебры: арифметику матриц, методы Гаусса, вычисление
 * детерминанта, ранга, нормы, операции транспонирования, поиска обратной
 * матрицы и возведения в степень.
 */
namespace linalg {

/**
 * @class Matrix
 * @brief Класс для представления и работы с матрицами произвольного размера.
 *
 * Обеспечивает хранение элементов в виде одномерного динамического массива и
 * предоставляет удобный интерфейс для выполнения арифметических и
 * алгебраических операций над матрицами: сложение, вычитание, умножение,
 * вычисление детерминанта, ранга, обратной матрицы и других.
 *
 * Класс поддерживает:
 * - безопасный доступ к элементам через операторы `()` и `[][]`;
 * - операции копирующего и перемещающего оприсваивания;
 * - агрегатную инициализацию.
 *
 * Используется в задачах линейной алгебры, решении СЛАУ и других
 * вычислительных методах.
 */
class Matrix {

private:
  /**
   * @brief Количество строк в матрице.
   */
  std::size_t m_rows;

  /**
   * @brief Количество столбцов в матрице.
   */
  std::size_t m_columns;

  /**
   * @brief Вместимость хранилища элементов матрицы (число элементов, на которые
   * выделена память). Может быть больше, чем фактическое количество элементов
   * (rows × columns).
   */
  std::size_t m_capacity;

  /**
   * @brief Указатель на область памяти, где хранятся элементы матрицы.
   *
   * Элементы располагаются построчно в виде одномерного массива длины
   * m_capacity. Элемент с индексами (i, j) находится по адресу
   * m_ptr[i * m_columns + j].
   */
  double *m_ptr;

  /**
   * @class Row
   * @brief Вспомогательный прокси-класс для обращения к строкам матрицы.
   *
   * Используется в реализации оператора Matrix::operator[], чтобы
   * предоставить удобный синтаксис двойного индексирования matrix[i][j].
   *
   * Объект Row не хранит всю строку отдельно, а лишь содержит указатель на
   * начало строки в общем хранилище Matrix::m_ptr и количество столбцов, что
   * позволяет безопасно индексировать элементы в пределах строки.
   */
  class Row {
  private:
    /**
     * @brief Указатель на первый элемент соответствующей строки в общем
     * хранилище матрицы.
     *
     * Используется для вычисления позиции элемента в строке при обращении через
     * оператор `[]`.
     */
    double *m_row_ptr;

    /**
     * @brief Количество элементов (столбцов) в строке.
     * Используется для проверки корректности индекса при обращении к элементу.
     */
    std::size_t m_columns;

  public:
    /**
     * @brief Конструктор строки.
     *
     * Инициализирует прокси-объект указателем на начало строки и количеством
     * столбцов.
     *
     * @param row_ptr Указатель на начало строки в хранилище матрицы.
     * @param columns Количество столбцов в матрице (число элементов в строке).
     */
    Row(double *row_ptr, std::size_t columns) noexcept;

    /**
     * @brief Оператор доступа к элементу строки (неконстантная версия).
     * Выполняет проверку выхода индекса за границы строки.
     *
     * @param col Индекс столбца (начиная с 0).
     * @return Ссылка на элемент строки.
     * @throws std::runtime_error Если `col >= m_columns`.
     */
    double &operator[](std::size_t col);

    /**
     * @brief Оператор доступа к элементу строки (константная версия).
     * Используется при работе с константными объектами `Matrix`.
     *
     * @param col Индекс столбца (начиная с 0).
     * @return Константная ссылка на элемент строки.
     * @throws std::runtime_error Если `col >= m_columns`.
     */
    const double &operator[](std::size_t col) const;
  };

public:
  /**
   * @brief Константа точности сравнения чисел.
   *
   * Используется при сравнении матриц с вещественными элементами, чтобы
   * избежать ошибок округления. По умолчанию `1e-9`.
   */
  inline static double EPSILON = 1e-9;

  /**
   * @brief Дефолтный конструктор.
   *
   * Создает пустую матрицу.
   * Все размеры (`m_rows`, `m_columns`, `m_capacity`) равны нулю, а `m_ptr` —
   * `nullptr`.
   *
   * @see Matrix(std::size_t, std::size_t)
   */
  Matrix();

  /**
   * @brief Конструктор с параметром (для матрицы с 1 столбцом).
   *
   * Создает вектор-столбец высотой `rows` и шириной 1.
   * Все элементы инициализируются нулями.
   *
   * @param rows Количество строк.
   * @throws std::runtime_error Если `rows == 0` и `columns == 0`.
   */
  explicit Matrix(std::size_t rows);

  /**
   * @brief Конструктор с параметрами (для произвольной матрицы).
   *
   * Создает матрицу размером `rows × columns` с нулевой инициализацией
   * элементов. Память выделяется динамически как непрерывный массив длиной
   * `rows * columns`.
   *
   * @param rows Количество строк.
   * @param columns Количество столбцов.
   * @throws std::runtime_error Если одна из размерностей равна 0 (но не обе).
   */
  explicit Matrix(std::size_t rows, std::size_t columns);

  /**
   * @brief Конструктор копирования.
   *
   * Создает новую матрицу, копируя все элементы из `other`.
   * Выделяет новую память, чтобы изменения в копии не влияли на исходную
   * матрицу.
   *
   * @param other Матрица, из которой копируются данные.
   */
  Matrix(const Matrix &other);

  /**
   * @brief Конструктор перемещения.
   *
   * Перехватывает владение ресурсами временной матрицы без копирования данных.
   * После вызова `other` становится пустой.
   *
   * @param other Временная матрица, ресурсы которой будут перемещены.
   */
  Matrix(Matrix &&other) noexcept;

  /**
   * @brief Конструктор из двумерного списка инициализации.
   *
   * Позволяет инициализировать матрицу при помощи фигурных скобок:
   * @code
   * Matrix A = {{1, 2}, {3, 4}};
   * @endcode
   *
   * @param list Двумерный список инициализации.
   * @throws std::runtime_error Если размеры строк различаются.
   */
  Matrix(std::initializer_list<std::initializer_list<double>> list);

  /**
   * @brief Конструктор из одномерного списка инициализации.
   *
   * Создает вектор-столбец с элементами из списка.
   *
   * @param list Одномерный список инициализации.
   */
  Matrix(std::initializer_list<double> list);

  /**
   * @brief Деструктор.
   *
   * Освобождает динамически выделенную память (`delete[] m_ptr`).
   * Вызывается автоматически при уничтожении объекта.
   */
  ~Matrix() { delete[] m_ptr; }

  /**
   * @brief Копирующий оператор присваивания.
   *
   * Делает текущую матрицу точной копией другой матрицы `other`.
   * Если вместимость (`capacity`) текущей матрицы недостаточна, память
   * перевыделяется.
   *
   * @param other Матрица, содержимое которой копируется.
   * @return Ссылка на текущий объект (*this).
   * @throw std::runtime_error Если размеры матриц несовместимы при копировании.
   */
  Matrix &operator=(const Matrix &other);

  /**
   * @brief Перемещающий оператор присваивания.
   *
   * Передает ресурсы временного объекта `other` текущей матрице без копирования
   * данных.
   *
   * @param other Временная матрица, ресурсы которой будут переданы.
   * @return Ссылка на текущий объект (*this).
   */
  Matrix &operator=(Matrix &&other) noexcept;

  /**
   * @brief Доступ к элементу матрицы по индексам через ().
   *
   * Позволяет обращаться к элементу матрицы как `matrix(i, j)`.
   *
   * @param row Индекс строки (начиная с 0).
   * @param col Индекс столбца (начиная с 0).
   * @return Ссылка на элемент матрицы с индексами (row, col).
   * @throw std::runtime_error Если индексы выходят за границы матрицы.
   * @see operator[](std::size_t)
   */
  double &operator()(std::size_t row, std::size_t col);

  /**
   * @brief Константный доступ к элементу матрицы по индексам.
   *
   * Используется для чтения элементов из константных объектов `Matrix`.
   * Возвращает константную ссылку, не позволяя изменять значение.
   *
   * @param row Индекс строки
   * @param col Индекс столбца
   * @return Константная ссылка на элемент (row, col).
   * @throw std::runtime_error Если индексы выходят за границы матрицы.
   * @see operator[](std::size_t) const
   */
  const double &operator()(std::size_t row, std::size_t col) const;

  /**
   * @brief Доступ к строке матрицы (неконстантная версия).
   *
   * Возвращает прокси-объект Row, предоставляющий доступ к элементам строки
   * с помощью двойного индексирования `matrix[i][j]`.
   *
   * @param row Индекс строки (начиная с 0).
   * @return Прокси-объект Row, ссылающийся на строку матрицы.
   * @throw std::runtime_error Если индекс строки выходит за границы.
   * @see Row
   */
  Row operator[](std::size_t row);

  /**
   * @brief Доступ к строке матрицы (константная версия).
   *
   * Возвращает прокси-объект Row, обеспечивающий доступ к элементам строки
   * только для чтения из константных объектов `Matrix`.
   *
   * @param row Индекс строки (начиная с 0).
   * @return Прокси-объект Row, предоставляющий доступ к строке.
   * @throw std::runtime_error Если индекс строки выходит за границы.
   * @see Row
   */
  const Row operator[](std::size_t row) const;

  /**
   * @brief Унарный плюс.
   * Возвращает копию текущей матрицы без изменений.
   * @return Копия текущей матрицы.
   */
  Matrix operator+() const;

  /**
   * @brief Унарный минус.
   *
   * Возвращает новую матрицу, в которой каждый элемент равен противоположному
   * по знаку элементу исходной матрицы. Исходная матрица не изменяется.
   *
   * @return Новая матрица с элементами `-a_ij`.
   */
  Matrix operator-() const;

  /**
   * @brief Поэлементное сложение с другой матрицей.
   *
   * Складывает текущую матрицу с `other` и сохраняет результат в текущем
   * объекте.
   *
   * @param other Матрица, с которой выполняется сложение.
   * @return Ссылка на текущую матрицу после операции.
   * @throw std::runtime_error Если размерности матриц различаются.
   * @see operator+(const Matrix&, const Matrix&)
   */
  Matrix &operator+=(const Matrix &other);

  /**
   * @brief Поэлементное вычитание другой матрицы.
   *
   * Вычитает матрицу `other` из текущей матрицы и сохраняет результат в текущем
   * объекте.
   *
   * @param other Матрица, которая вычитается.
   * @return Ссылка на текущую матрицу после операции.
   * @throw std::runtime_error Если размерности матриц различаются.
   * @see operator-(const Matrix&, const Matrix&)
   */
  Matrix &operator-=(const Matrix &other);

  /**
   * @brief Матричное умножение.
   *
   * Выполняет умножение текущей матрицы на правую матрицу `other`
   * и сохраняет результат в текущей матрице.
   *
   * @param other Матрица, на которую выполняется умножение.
   * @return Ссылка на текущую матрицу после умножения.
   * @throw std::runtime_error Если количество столбцов левой матрицы не
   * совпадает с количеством строк правой.
   * @see operator*(const Matrix&, const Matrix&)
   */
  Matrix &operator*=(const Matrix &other);

  /**
   * @brief Умножение матрицы на скаляр.
   *
   * Каждый элемент текущей матрицы умножается на заданное число `value`.
   *
   * @param value Числовой множитель.
   * @return Ссылка на текущую матрицу после операции.
   */
  Matrix &operator*=(double value);

  /**
   * @brief Метод, проверяющий пустая ли матрица.
   * @return `true`, если матрица пуста, иначе `false`.
   */
  bool empty() const noexcept { return size() == 0; }

  /**
   * @brief Возвращает количество строк в матрице.
   * Метод не изменяет объект и не выбрасывает исключений.
   * @return Количество строк матрицы.
   */
  std::size_t rows() const noexcept { return m_rows; }

  /**
   * @brief Возвращает количество столбцов в матрице.
   * Метод не изменяет объект и не выбрасывает исключений.
   * @return Количество столбцов матрицы.
   */
  std::size_t columns() const noexcept { return m_columns; }

  /**
   * @brief Возвращает вместимость матрицы (capacity).
   *
   * Вместимость — это количество элементов, на которые выделена память.
   * Может быть больше фактического размера матрицы (`rows() * columns()`),
   * если память была зарезервирована заранее методом `reserve()`.
   *
   * @return Общее количество элементов, для которых выделена память.
   */
  std::size_t capacity() const noexcept { return m_capacity; }

  /**
   * @brief Возвращает текущее количество элементов в матрице.
   * Размер определяется как произведение числа строк на число столбцов.
   * @return Общее количество элементов (rows × columns).
   */
  std::size_t size() const noexcept { return m_rows * m_columns; }

  /**
   * @brief Возвращает указатель на первый элемент матрицы.
   * Используется для итерации по элементам матрицы.
   * @return Указатель на первый элемент (`m_ptr`).
   */
  double *begin() noexcept { return m_ptr; }

  /**
   * @brief Возвращает указатель на элемент, следующий за последним.
   * Используется для итераци.
   * @return Указатель на элемент, следующий за последним (`m_ptr + size()`).
   */
  double *end() noexcept { return m_ptr + size(); }

  /**
   * @brief Константная версия итератора begin().
   *
   * Позволяет безопасно проходить по элементам матрицы без возможности их
   * изменения.
   *
   * @return Константный указатель на первый элемент матрицы.
   */
  const double *begin() const noexcept { return m_ptr; }

  /**
   * @brief Константная версия итератора end().
   *
   * Возвращает константный указатель на элемент, следующий за последним,
   * для безопасной итерации по матрице.
   *
   * @return Константный указатель на элемент после последнего.
   */
  const double *end() const noexcept { return m_ptr + size(); }

  /**
   * @brief Изменяет размерность матрицы.
   *
   * Меняет количество строк и столбцов без пересоздания объекта.
   * Если новое количество элементов превышает текущую вместимость
   * (`capacity()`), автоматически вызывается метод `reserve()` для выделения
   * дополнительной памяти.
   *
   * @param rows Новое количество строк.
   * @param columns Новое количество столбцов.
   *
   * @throw std::runtime_error Если одно из измерений равно нулю, а другое —
   * нет.
   */
  void reshape(std::size_t rows, std::size_t columns);

  /**
   * @brief Резервирует память под указанное количество элементов.
   *
   * Позволяет заранее выделить память, чтобы избежать лишних перераспределений
   * при изменении размера матрицы. Старые данные сохраняются.
   *
   * @param number Новое количество элементов, для которых нужно зарезервировать
   * память.
   */
  void reserve(std::size_t number);

  /**
   * @brief Очищает матрицу без освобождения памяти.
   * @post empty() == true
   */
  void clear() noexcept;

  /**
   * @brief Уменьшает вместимость матрицы до её текущего размера.
   * Освобождает неиспользуемую память, сохраняя содержимое матрицы.
   * @post capacity() == size()
   */
  void shrink_to_fit();

  /**
   * @brief Обменивает содержимое текущей матрицы с другой.
   * Меняет местами указатели, размеры и вместимость без копирования данных.
   *
   * @param other Другая матрица, с которой выполняется обмен.
   * @post Матрицы полностью меняются своими данными.
   */
  void swap(Matrix &other) noexcept;

  /**
   * @brief Вычисляет евклидову норму матрицы.
   *
   * Норма определяется как корень из суммы квадратов всех элементов:
   *
   * @return Действительное число — норма матрицы.
   * @throw std::runtime_error Если матрица пуста.
   */
  double norm() const;

  /**
   * @brief Вычисляет след матрицы.
   *
   * След — это сумма диагональных элементов квадратной матрицы.
   *
   * @return Значение следа (сумма элементов a[i][i]).
   * @throw std::runtime_error Если матрица пуста или не является квадратной.
   */
  double trace() const;

  /**
   * @brief Вычисляет определитель квадратной матрицы.
   *
   * Определитель вычисляется с помощью прямого хода метода Гаусса.
   *
   * @return Определитель матрицы - действительное число.
   * @throw std::runtime_error Если матрица пуста или не является квадратной.
   */
  double det() const;

  /**
   * @brief Вычисляет ранг матрицы.
   *
   * Ранг определяется как количество ненулевых строк в ступенчатой форме,
   * полученной методом Гаусса.
   *
   * @return Целое число — ранг матрицы.
   */
  size_t rank() const;

  /**
   * @brief Меняет местами две строки матрицы.
   *
   * Используется при приведении матрицы к ступенчатому виду.
   *
   * @param i Индекс первой строки.
   * @param j Индекс второй строки.
   */
  void swap_rows(std::size_t i, std::size_t j) noexcept;

  /**
   * @brief Прямой ход метода Гаусса.
   *
   * Преобразует матрицу к верхнетреугольному виду.
   * Используется для решения СЛАУ, вычисления определителя и ранга.
   *
   * @return Ссылка на текущий объект (для цепочек вызовов).
   * @throw std::runtime_error Если матрица пуста.
   */
  Matrix &gauss_forward();

  /**
   * @brief Обратный ход метода Гаусса.
   *
   * Приводит матрицу к единичному виду после прямого хода.
   * Используется для нахождения обратной матрицы и решения СЛАУ.
   *
   * @return Ссылка на текущий объект (для цепочек вызовов).
   * @throw std::runtime_error Если на диагонали встречается нулевой элемент.
   */
  Matrix &gauss_backward();

  /**
   * @brief Подсчитывает количество перестановок строк при приведении матрицы к
   * ступенчатому виду.
   *
   * Метод используется внутри вычисления определителя (det()) для учета знака:
   * det(A) = (-1)^swap_count · произведение диагональных элементов
   *
   * @return Количество перестановок строк (неотрицательное целое число).
   * @note Метод не изменяет текущую матрицу, работает с временной копией.
   * @see det(), gauss_forward()
   */
  int swap_count() const;

  /**
   * @brief Выполняет LU-разложение матрицы.
   *
   * Раскладывает квадратную матрицу A на произведение двух матриц:
   * A = L · U, где:
   * - L (Lower) — нижняя треугольная матрица с единицами на диагонали
   * - U (Upper) — верхняя треугольная матрица
   *
   * Алгоритм работы - прямой ход метода Гаусса
   * без выбора главного элемента:
   *
   * @return Пара матриц (L, U), где L — нижнетреугольная, U —
   * верхнетреугольная.
   * @throw std::runtime_error Если матрица пустая.
   * @throw std::runtime_error Если матрица не квадратная.
   * @throw std::runtime_error Если встречен нулевой опорный элемент (матрица
   * вырожденная или требуется выбор главного элемента).
   *
   * @post Исходная матрица не изменяется.
   * @see gauss_forward(), det()
   */
  std::pair<Matrix, Matrix> lu_decompose() const;
};

/**
 * @brief Обмен содержимого двух матриц.
 *
 * Производит обмен полей между матрицами при помощи
 * метода `swap`
 *
 * @param left_matrix Первая матрица.
 * @param right_matrix Вторая матрица.
 * @see void swap(Matrix &other)
 */
inline void swap(Matrix &left_matrix, Matrix &right_matrix) {
  left_matrix.swap(right_matrix);
}

/**
 * @brief Поэлементное сложение двух матриц.
 *
 * @param left Левая матрица.
 * @param right Правая матрица.
 * @return Новая матрица — результат сложения.
 * @throw std::runtime_error Если размеры матриц не совпадают.
 */
Matrix operator+(const Matrix &left, const Matrix &right);

/**
 * @brief Поэлементное вычитание матриц.
 *
 * @param left Уменьшаемая матрица.
 * @param right Вычитаемая матрица.
 * @return Новая матрица — результат вычитания.
 * @throw std::runtime_error Если размеры матриц не совпадают.
 */
Matrix operator-(const Matrix &left, const Matrix &right);

/**
 * @brief Матричное умножение.
 *
 * @param left Левая матрица (m×n).
 * @param right Правая матрица (n×k).
 * @return Новая матрица размером (m×k).
 * @throw std::runtime_error Если количество столбцов левой матрицы не равно
 * количеству строк правой.
 */
Matrix operator*(const Matrix &left, const Matrix &right);

/**
 * @brief Умножение матрицы на скаляр слева.
 *
 * @param left Матрица.
 * @param value Числовой множитель.
 * @return Новая матрица с элементами, умноженными на value.
 */
Matrix operator*(const Matrix &left, double value);

/**
 * @brief Умножение матрицы на скаляр справа.
 *
 * @param value Числовой множитель.
 * @param right Матрица.
 * @return Новая матрица с элементами, умноженными на value.
 */
Matrix operator*(double value, const Matrix &right);

/**
 * @brief Сравнение двух матриц на равенство.
 *
 * Матрицы считаются равными, если совпадают их размеры и все элементы
 * попарно равны с точностью EPSILON.
 *
 * @param left Левая матрица.
 * @param right Правая матрица.
 * @return true, если матрицы равны, иначе false.
 * @note Использует EPSILON для сравнения вещественных чисел.
 */
bool operator==(const Matrix &left, const Matrix &right);

/**
 * @brief Сравнение двух матриц на неравенство.
 *
 * @param left Левая матрица.
 * @param right Правая матрица.
 * @return true, если матрицы не равны, иначе false.
 */
bool operator!=(const Matrix &left, const Matrix &right);

/**
 * @brief Оператор вывода матрицы в поток.
 *
 * Выводит матрицу в формате с вертикальными разделителями и выравниванием
 * столбцов.
 *
 * @param os Выходной поток.
 * @param matrix Выводимая матрица.
 * @return Ссылка на поток os.
 */
std::ostream &operator<<(std::ostream &os, const Matrix &matrix);

/**
 * @brief Оператор ввода матрицы из потока.
 *
 * Считывает матрицу из потока `is`. Строки должны быть обрамлены символами '|'.
 * Разделителями являются пробелы и символы новой строки. Считывание продолжается
 * до конца файла (eof).
 *
 * @param is Входной поток.
 * @param matrix Матрица для сохранения результата.
 * @return Ссылка на поток `is`.
 * @throw std::runtime_error при ошибках форматирования, таких как:
 *        - отсутствие или неверный символ '|' в начале или конце строки;
 *        - неверное количество элементов в строках (отличается от первой);
 *        - пустая матрица с несколькими строками.
 */
std::istream &operator>>(std::istream &is, Matrix &matrix);

/**
 * @brief Транспонирование матрицы.
 *
 * Меняет местами строки и столбцы: элемент (i, j) становится элементом (j, i).
 *
 * @param matrix Исходная матрица.
 * @return Транспонированная матрица.
 */
Matrix transpose(const Matrix &matrix);

/**
 * @brief Горизонтальная конкатенация двух матриц.
 *
 * Объединяет две матрицы по столбцам: [left | right].
 *
 * @param left Левая матрица.
 * @param right Правая матрица.
 * @return Новая матрица размером (rows × (left.columns + right.columns)).
 * @throw std::runtime_error Если количество строк матриц не совпадает.
 */
Matrix concatenate(const Matrix &left, const Matrix &right);

/**
 * @brief Решение системы линейных уравнений Ax = f методом Гаусса.
 *
 * @param matr_A Матрица коэффициентов (должна быть квадратной и невырожденной).
 * @param vec_f Вектор правых частей.
 * @return Вектор решения x.
 * @throw std::runtime_error Если система не имеет единственного решения.
 */
Matrix solve(const Matrix &matr_A, const Matrix &vec_f);

/**
 * @brief Возведение квадратной матрицы в целую степень.
 *
 * @param matr Квадратная матрица.
 * @param power Показатель степени (может быть отрицательным).
 * @return Матрица в степени power.
 * @throw std::runtime_error Если матрица не квадратная.
 * @note При отрицательной степени вычисляется обратная матрица и возводится в
 * |power|.
 * @note При power = 0 возвращается единичная матрица.
 */
Matrix power(const Matrix &matr, int power);

/**
 * @brief Создание единичной матрицы заданного размера.
 *
 * @param length Размер единичной матрицы (length × length).
 * @return Единичная матрица размера length.
 */
Matrix create_identity_matrix(std::size_t length);

/**
 * @brief Вычисление обратной матрицы.
 *
 * @param matrix Квадратная невырожденная матрица.
 * @return Обратная матрица.
 * @throw std::runtime_error Если матрица не квадратная или вырожденная.
 */
Matrix invert(const Matrix &matrix);
} // namespace linalg

#endif // LINALG_MATRIX_H